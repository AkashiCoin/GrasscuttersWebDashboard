<html lang="zh">

<head>
    <meta charset="utf-8">
    <title>Grasscutters 网页控制台</title>
    <meta name="viewport" content="width=device-width">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="css/mui.min.css">
    <script src="js/mui.min.js"></script>
    <header class="mui-bar mui-bar-nav">
        <h1 class="mui-title">Grasscutters 网页控制台</h1>
    </header>
</head>

<body>
<div class="mui-content">

    <div class="mui-card" style="margin-bottom: 35px;">
        <div class="mui-card-header">在线玩家
            <button type="button" data-loading-text="请稍后" class="mui-btn" onclick="updatePlayerList()">刷新</button>
        </div>
        <ul class="mui-table-view" id="id-player-list">
        </ul>
    </div>
</div>

<script>
    mui.init();

    function getQueryVariable(variable) {
        const query = window.location.search.substring(1);
        const vars = query.split("&");
        for (let i = 0; i < vars.length; i++) {
            const pair = vars[i].split("=");
            if (pair[0] === variable) {
                return pair[1];
            }
        }
        return false;
    }

    let ServerAddress = getQueryVariable("server");
    let ServerKey = getQueryVariable("key");
    if (ServerAddress === false) {
        mui.prompt("请输入服务器连接地址", "服务器连接地址", "提示", ["连接"], function (e) {
            const server_address = e.value;
            if (server_address.indexOf("ws://") < 0 && server_address.indexOf("wss://") < 0) {
                mui.alert("服务器地址不正确", "连接失败", "刷新", function () {
                    location.reload();
                });
            } else {
                ServerAddress = server_address;
            }

            mui.prompt("请输入连接码", "连接码", "提示", ["连接"], function (e) {
                const server_key = e.value;
                if (server_key.length !== 8) {
                    mui.alert("连接码不正确", "连接失败", "刷新", function () {
                        location.reload();
                    });
                } else {
                    ServerKey = server_key;
                    ContentServer();
                }
            });

        });
    } else if (ServerKey === false) {
        mui.prompt("请输入连接码", "连接码", "提示", ["连接"], function (e) {
            const server_key = e.value;
            if (server_key.length !== 8) {
                mui.alert("连接码不正确", "连接失败", "刷新", function () {
                    location.reload();
                });
            } else {
                ServerKey = server_key;
                ContentServer();
            }
        });
    }


    let ws;

    function updatePlayerList() {
        ws.send("{\"type\":\"Player\",\"data\":\"0\"}");
    }

    function ContentServer() {
        //判断server_address是否是一个有效的websocket地址
        ws = new WebSocket(ServerAddress + "?key=" + ServerKey);
        ws.onmessage = function (event) {
            const server_msg = JSON.parse(event.data);
            switch (server_msg['eventName']) {
                case 'auth':
                    if (server_msg['data'] === '连接成功') {
                        mui.toast("连接成功");
                    } else {
                        mui.alert(server_msg['data'], "连接失败", "刷新", function () {
                            location.reload();
                        });
                    }
                    break;
                case 'PlayerList':
                    const player_list = server_msg['data'];
                    //遍历玩家列表
                    let player_list_html = "";
                    for (let i = 0; i < player_list.length; i++) {
                        const player_data = player_list[i];
                        player_list_html += "<li class=\"mui-table-view-cell\">\n" +
                            "                        <div class=\"mui-slider-cell\">\n" +
                            "                            <div class=\"mui-slider-cell-right\">\n" +
                            "                                <p class=\"mui-ellipsis\">UID:" + player_data['uid'] + "</p>\n" +
                            "                                <p class=\"mui-ellipsis\">昵称:" + player_data['nickname'] + "</p>\n" +
                            "                                <p class=\"mui-ellipsis\">签名:" + player_data['signature'] + "</p>\n" +
                            "                                <p class=\"mui-ellipsis\">等级:" + player_data['Level'] + "级</p>\n" +
                            "                                <p class=\"mui-ellipsis\">世界等级:" + player_data['worldLevel'] + "级</p>\n" +
                            "                                <p class=\"mui-ellipsis\">等级:" + player_data['Level'] + "级</p>\n" +
                            "                                <p class=\"mui-ellipsis\">坐标:" + player_data['pos'] + "</p>\n" +
                            "                            </div>\n" +
                            "                        </div>\n" +
                            "                    </li>";
                    }
                    document.getElementById("id-player-list").innerHTML = player_list_html;
                    break;
                default:
                    break;
            }
        }
        ws.onclose = function () {
            console.log("连接关闭");
            mui.alert("与服务器断开连接，请刷新", "连接失败", "确定", function () {
            });
        }
    }

    function do_cmd(e) {
        const send_msg = {
            "type": "CMD",
            "data": e
        };
        const send_msg_str = JSON.stringify(send_msg);
        ws.send(send_msg_str);
    }
</script>
</body>

</html>